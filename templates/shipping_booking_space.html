{% extends 'base.html' %}
{% from '_render_input.html' import render_input_text, render_input_number, render_input_date, render_input_checkbox %}

{% block head %}
<title> {{ page_title }} </title>
{% endblock %}

{% block body %}
{% with title=page_title %}
{% include 'header.html' %}
{% endwith %}

<div class="mt-4">{% include 'flash.html' %}</div>

{% if page_title == 'Booking Confirm' and (not booking.so or booking.so.strip() == '') %}
<div class="container p-4">
  <div class="alert alert-warning" role="alert">
    <strong>Warning:</strong> Please add a valid SO before confirming the booking.
    <a href="{{ url_for('booking.booking_edit', bk_id=booking.bk_id, return_to_confirm=1) }}" class="btn btn-sm btn-warning ms-3">Edit Booking</a>
  </div>
</div>
{% endif %}

<section class="container p-4">
  <h3>Booking Details</h3>

  <table class="table align-middle m-0">
    <thead>
      {% if current_user.role.rank == 'admin' %}
      <th>ID</th>
      {% endif %}
      <th>SO</th>
      <th>Final Destination</th>
      <th>Contract/Coloader</th>
      <th>Shipper</th>
      <th>Consignee</th>
      <th>Term</th>
      <th>Sales</th>
      <th>Sale Price</th>
      <th>Void</th>
      {% if current_user.role.rank == 'admin' %}
      <th>Status</th>
      <th>Last Modified</th>
      <th>By</th>
      {% endif %}
    </thead>
    <tbody id="results-booking">
      {% set is_sales = (current_user.role.rank == 'sales') %}
      {% set is_red = booking.void or space.spcstatus in ['BK_CANCEL','INVALID'] %}
      {% set is_green = (space.spcstatus == 'BK_CONFIRM' and not booking.void) %}
      <tr class="{% if is_sales %}{% if is_red %}row-soft-red{% elif is_green %}row-soft-green text-lighter{% endif %}{% endif %}">
        {% if current_user.role.rank == 'admin' %}
            <td>{{ space.spc_id }}</td>
        {% endif %}
            <td {% if page_title == 'Booking Confirm' and (not booking.so or booking.so.strip() == '') %}class="table-warning fw-bold"{% endif %}>
              {{ booking.so if booking.so else '(Empty)' }}
            </td>
            <td>{{ booking.findest }}</td>
            <td>{{ booking.ct_cl }}</td>
            <td>{{ booking.shipper }}</td>
            <td>{{ booking.consignee }}</td>
            <td>{{ booking.term }}</td>
            <td>{{ users[booking.sales] | capitalize }}</td>
            <td>{{ booking.saleprice }}</td>
            <td>{{ booking.void_yesno() }}</td>
        {% if current_user.role.rank == 'admin' %}
            <td>{{ space.spcstatus }}</td>
            <td>{{ space.last_modified_at.strftime('%Y-%m-%d %H:%M') }}</td>
            <td>{{ space.last_modified_by }}</td>
        {% endif %}
      </tr>
    </tbody>
  </table>
</section>
<section class="container p-4">
  <h3>Booking Details</h3>

  <form method="POST" class="mt-4">
    {{ render_input_text(name='Remark', id='remark', value=data.remark) }}

    <div class="d-inline-flex gap-2 mt-3">
      <a class="btn btn-danger" href="javascript:history.back()">Cancel</a>
      {% if page_title == 'Booking Confirm' and (not booking.so or booking.so.strip() == '') %}
        <button class="btn btn-primary" type="button" disabled title="SO must be filled before confirming">Confirm action (SO Required)</button>
      {% else %}
        <input class="btn btn-primary" type="submit" value="Confirm action" />
      {% endif %}
    </div>
  </form>
</section>
{% endblock %}