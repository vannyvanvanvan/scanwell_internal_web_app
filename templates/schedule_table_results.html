{% if results %}
{% for result in results %}

{% if highlighted["schedule"] and highlighted["schedule"]==result.sch_id %}
<tr class="highlighted-row schedule-row">
  {% else %}
<tr class="schedule-row">
  {% endif %}
  {% if current_user.role.rank == 'admin' %}
  <td>{{ result.sch_id }}</td>
  {% endif %}

  <td>{{ result.carrier }}</td>
  <td>{{ result.service }}</td>
  <td>{{ result.routing }}</td>
  <td>{{ result.mv }}</td>
  <td>{{ result.pol }}</td>
  <td>{{ result.pod }}</td>
  <td>{{ result.cyopen.strftime('%Y-%m-%d') }}</td>
  <td>{{ result.sicutoff.strftime('%Y-%m-%d %H:%M') }}</td>
  <td>{{ result.cycvcls.strftime('%Y-%m-%d %H:%M') }}</td>
  <td>{{ result.etd.strftime('%Y-%m-%d') }}</td>
  <td>{{ result.eta.strftime('%Y-%m-%d') }}</td>

  <td>
    <div class="d-flex justify-content-end gap-2">


      <div data-bs-toggle="tooltip" data-bs-title="View schedule details">
        <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse"
          data-bs-target="#collapse-sch-{{ result.sch_id }}" aria-expanded="false"
          aria-controls="collapse-sch-{{ result.sch_id }}">
          <i class="bi bi-zoom-in"></i>
        </button>
      </div>

      {% if current_user.role.rank == 'admin' or current_user.id == result.owner %}
      <div data-bs-toggle="tooltip" data-bs-title="Add space">
        <a class="btn btn-primary" href="{{ url_for('space.space_add', sch_id=result.sch_id) }}">
          <i class="bi bi-plus-lg"></i>
        </a>
      </div>
      {% endif %}

      {% if current_user.role.rank == 'admin' or current_user.id == result.owner %}
      <div data-bs-toggle="tooltip" data-bs-title="Edit schedule">
        <a class="btn btn-warning" href="{{ url_for('schedule.schedule_edit', sch_id=result.sch_id) }}">
          <i class="bi bi-pencil-square"></i>
        </a>
      </div>
      {% endif %}
    </div>
  </td>
</tr>
<tr>
  <td colspan="15" class="bg-body-tertiary ps-4 pe-4 pt-0 pb-0">
    <div class="collapse" id="collapse-sch-{{ result.sch_id }}">

      <div class="d-flex justify-content-between align-items-baseline gap-2 mt-4 mb-2">
        <h5 class="heading-space">Space</h5>
      </div>
      <div class="border rounded overflow-hidden mt-2 mb-4">
        <table class="table align-middle m-0">
          <thead>
            <th>ID</th>
            <th>Size</th>
            <th>Avg. Rate</th>
            <th>Sug. Rate</th>
            <th>Rate Valid</th>
            <th>Proport</th>
            <th>Status</th>
            {% if current_user.role.rank == 'admin', 'CS' %}
            <th>Last Modified</th>
            {% endif %}
            <th></th>
          </thead>
          <tbody>
            {% if result.spaces %}
            {% for space in result.spaces %}
            {% if highlighted["space"] and highlighted["space"]==space.spc_id %}
            <tr class="highlighted-row space-row">
              {% else %}
            <tr class="space-row">
              {% endif %}
              <td>{{ space.spc_id }}</td>
              <td>{{ space.size }}</td>
              <td>{{ space.avgrate }}</td>
              <td>{{ space.sugrate }}</td>
              <td>{{ space.ratevalid.strftime('%Y-%m-%d %H:%M') }}</td>
              <td>{{ space.proport_yesno() }}</td>
              <td>{{ space.spcstatus }}</td>
              {% if current_user.role.rank == 'admin', 'CS' %}
              <td>{{ space.last_modified_at.strftime('%Y-%m-%d %H:%M') }} by {{ users[space.last_modified_by] | capitalize }}</td>
              <td>
                <div class="d-flex justify-content-end gap-2">
                  <div data-bs-toggle="tooltip" data-bs-title="View space details">
                    <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse"
                      data-bs-target="#collapse-spc-{{ space.spc_id }}" aria-expanded="false"
                      aria-controls="collapse-spc-{{ space.spc_id }}">
                      <i class="bi bi-zoom-in"></i>
                    </button>
                  </div>
                  {% if current_user.role.rank in ['admin', 'sales'] %}
                  <div data-bs-toggle="tooltip" data-bs-title="Create reserve">
                    <a class="btn btn-primary" href="{{ url_for('reserve.reserve_add', spc_id=space.spc_id) }}">
                      <i class="bi bi-plus-lg"></i>
                    </a>
                  </div>
                  {% endif %}
                  {% if current_user.role.rank == 'admin' or current_user.id == result.owner %}
                  <div data-bs-toggle="tooltip" data-bs-title="Edit space">
                    <a class="btn btn-warning" href="{{ url_for('space.space_edit', spc_id=space.spc_id) }}">
                      <i class="bi bi-pencil-square"></i>
                    </a>
                  </div>
                  {% endif %}
                </div>
              </td>
              {% endif %}
            </tr>
            <tr>
              <td colspan="11" class="bg-body-tertiary ps-4 pe-4 pt-0 pb-0">
                <div class="collapse" id="collapse-spc-{{ space.spc_id }}">
                  
                  {% with reserves=space.reserves %}
                  {% include 'reserve_table.html' %}
                  {% endwith %}

                  {% with bookings=space.bookings %}
                  {% include 'booking_table.html' %}
                  {% endwith %}

                </div>
              </td>
            </tr>
            {% endfor %}
            {% else %}
            <tr>
              <td colspan="14">No spaces assigned.</td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>

    </div>
  </td>
</tr>
{% endfor %}
{% else %}
<tr>
  <td colspan="14">No results found.</td>
</tr>
{% endif %}