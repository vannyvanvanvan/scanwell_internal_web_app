{% extends 'base.html' %}
{% block head %}
<title>Users</title>
{% endblock %}

{% block body %}
{% with title='Admin - Users' %}
{% include 'header.html' %}
{% endwith %}

<div class="container mt-4">
  <h1>Users</h1>
  {% include 'flash.html' %}
  {% set rank_labels = {
    'admin': 'admin',
    'cs': 'cs',
    'sales': 'sales',
    'cs_sales': 'CS_Sales'
  } %}
  <div class="card mb-4">
    <div class="card-body">
      <h2 class="h5 mb-3">Create New User</h2>
      {% set ranks = available_ranks if available_ranks is defined else ['admin', 'cs', 'sales', 'cs_sales'] %}
      <form method="post" novalidate>
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label" for="username">Username</label>
            <input
              id="username"
              class="form-control"
              type="text"
              name="username"
              value="{{ form_data.username if form_data else '' }}"
              required
              autocomplete="username"
            />
          </div>
          <div class="col-md-3">
            <label class="form-label" for="friendly_name">Name</label>
            <input
              id="friendly_name"
              class="form-control"
              type="text"
              name="friendly_name"
              value="{{ form_data.friendly_name if form_data else '' }}"
              autocomplete="name"
            />
          </div>
          <div class="col-md-2">
            <label class="form-label" for="rank">Role</label>
            <select id="rank" class="form-select" name="rank" required>
              <option value="" disabled {{ '' if form_data else 'selected' }}>Select role</option>
              {% for role in ranks %}
              <option value="{{ role }}" {{ 'selected' if form_data and form_data.rank == role else '' }}>{{ rank_labels.get(role, role) }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label" for="password">New Password</label>
            <input
              id="password"
              class="form-control"
              type="password"
              name="password"
              required
              autocomplete="new-password"
            />
          </div>
          <div class="col-md-1 d-flex align-items-end">
            <button class="btn btn-primary w-100" type="submit">Add</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  <table class="table table-striped">
    <thead>
      <tr>
        <th>ID</th>
        <th>Username</th>
        <th>Name</th>
        <th>Role</th>
        <th>Created</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for user in users %}
      <tr>
        <td>{{ user.id }}</td>
        <td>{{ user.username }}</td>
        <td>{{ user.friendly_name or '' }}</td>
        {% set rank_value = user.role.rank if user.role else None %}
        <td>{{ rank_labels.get(rank_value, rank_value or 'â€”') }}</td>
        <td>{{ user.date_created.strftime('%Y-%m-%d %H:%M') if user.date_created else '' }}</td>
        <td>
          <a class="btn btn-sm btn-primary" href="{{ url_for('admin.admin_user_view', user_id=user.id) }}">View</a>
          <a class="btn btn-sm btn-secondary" href="{{ url_for('admin.admin_user_edit', user_id=user.id) }}">Edit</a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <a class="btn btn-secondary" href="{{ url_for('admin.admin_home') }}">Back</a>
</div>
{% endblock %}


